- name: Create zabbix directory
  win_file:
    path: 'C:\Zabbix'
    state: directory

- name: Download zabbix-agent.zip
  win_get_url:
    url: '{{ zabbix_agent_url }}'
    dest: C:\Zabbix\zabbix_agent.zip

- name: Unzip zabbix-agent.zip
  win_unzip:
    src: C:\Zabbix\zabbix_agent.zip
    dest: C:\Zabbix\
    delete_archive: yes

- name: Create zabbix config directory
  win_file:
    path: 'C:\Zabbix\conf\conf.d'
    state: directory

- name: Set RemoteCommands
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    insertafter='^# EnableRemoteCommands=0$'
    line='EnableRemoteCommands=1'

- name: Set LogRemoteCommands
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    insertafter='^# LogRemoteCommands=0$'
    line='LogRemoteCommands=1'

- name: Set Server ip
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    backrefs=yes
    regexp='^Server=.*[0-9]$'
    line='Server={{ zabbix_server_ip }}'

- name: Set ServerActive ip
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    backrefs=no
    regexp='^ServerActive=.*[0-9]$'
    line='ServerActive={{ zabbix_server_ip }}:10051'

- name: Set Hostname
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    backrefs=yes
    regexp='^Hostname=.*'
    line='Hostname={{ ansible_hostname }}'

- name: Set RefreshActiveChecks
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    insertafter='^# RefreshActiveChecks=120$'
    line='RefreshActiveChecks=60'

- name: Set MaxLinesPerSecond
  lineinfile: >
    dest=/etc/zabbix/zabbix_agentd.conf
    state=present
    insertafter='^# MaxLinesPerSecond=20$'
    line='MaxLinesPerSecond=100'

- name: Install zabbix-agent
  win_command: CMD /C "C:\Zabbix\bin\win64\zabbix_agentd.exe --config C:\Zabbix\conf\zabbix_agentd.win.conf --install"

- name: Start zabbix-agent
  win_command: CMD /C "C:\Zabbix\bin\win64\zabbix_agentd.exe --config C:\Zabbix\conf\zabbix_agentd.win.conf --start"
